<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1, user-scalable=no" />
  <title>Catstroker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1>üò∫ Catstroker</h1>
    <div id="cat-wrap">
      <img id="cat" src="https://placekitten.com/360/360" alt="–∫–æ—Ç–∏–∫" />
    </div>

    <div id="stats">
      <div>–ú—É—Ä—á–∏–∫–∏: <b id="purrs">0</b></div>
      <div>–≠–Ω–µ—Ä–≥–∏—è: <b id="energy">0</b>/<b id="max_energy">0</b></div>
      <div>–ó–∞ –ª–∞—Å–∫—É: <b id="per">1</b> ‚Ä¢ –ü–∞—Å—Å–∏–≤: <b id="passive">0</b>/–º–∏–Ω</div>
    </div>

    <div class="buttons">
      <button id="stroke">–ì–ª–∞–¥–∏—Ç—å üêæ</button>
      <button id="daily">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</button>
      <button id="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      <button id="top">üèÜ –¢–æ–ø-10</button>
    </div>

    <div id="shop-panel" class="panel hidden">
      <h3>–ú–∞–≥–∞–∑–∏–Ω</h3>
      <div class="item" data-key="paw_glove">–ü–µ—Ä—á–∞—Ç–∫–∞ –ª—é–±–≤–∏ ‚Äî –±–æ–ª—å—à–µ –º—É—Ä—á–∏–∫–æ–≤</div>
      <div class="item" data-key="cloud_pillow">–ü–æ–¥—É—à–∫–∞ –∏–∑ –æ–±–ª–∞–∫–æ–≤ ‚Äî –±–æ–ª—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏</div>
      <div class="item" data-key="purr_modulator">–ú—É—Ä—á–∏–∫–æ—Ñ–æ–Ω ‚Äî –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div>
      <button id="close-shop">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="log"></div>
  </main>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.ready();
      // –∞–≤—Ç–æ—Ç–µ–º–∞
      document.documentElement.style.setProperty("--tg-bg", tg.themeParams.bg_color || "#fff0f5");
      document.documentElement.style.setProperty("--tg-text", tg.themeParams.text_color || "#2c2c2c");
    }

    const BACKEND = (new URL(document.location)).searchParams.get("api") || "%BACKEND_PLACEHOLDER%";
    let serverToken = null;
    let state = null;
    let strokeQueue = 0;
    let busy = false;

    const $ = (id) => document.getElementById(id);
    function setState(s) {
      state = s;
      $("purrs").innerText = s.purrs;
      $("energy").innerText = s.energy;
      $("max_energy").innerText = s.max_energy;
      $("per").innerText = s.per_stroke;
      $("passive").innerText = s.passive_per_min;
    }
    function log(msg) {
      const el = document.createElement("div");
      el.textContent = msg;
      $("log").prepend(el);
    }

    async function auth() {
      if (!tg) { alert("–û—Ç–∫—Ä–æ–π –≤ Telegram"); return; }
      const initData = tg.initData;
      const res = await fetch(`${BACKEND}/api/auth`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ initData })
      });
      if (!res.ok) {
        log("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
        return;
      }
      const data = await res.json();
      serverToken = data.token;
    }

    async function fetchState() {
      const res = await fetch(`${BACKEND}/api/state`, {
        headers: {Authorization: `Bearer ${serverToken}`}
      });
      if (res.ok) setState(await res.json());
    }

    async function sendStrokes(n) {
      if (!serverToken) return;
      if (busy) return;
      busy = true;
      try {
        const res = await fetch(`${BACKEND}/api/stroke`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${serverToken}` },
          body: JSON.stringify({ strokes: n })
        });
        if (res.ok) {
          const s = await res.json();
          setState(s);
        }
      } finally {
        busy = false;
      }
    }

    async function claimDaily() {
      const res = await fetch(`${BACKEND}/api/daily`, {
        method: "POST",
        headers: { Authorization: `Bearer ${serverToken}` }
      });
      if (res.ok) {
        const data = await res.json();
        setState(data.state);
        log(`üéÅ +${data.reward} –º—É—Ä—á–∏–∫–æ–≤`);
      } else {
        const t = await res.text();
        log("–ï—â—ë —Ä–∞–Ω–æ –¥–ª—è –±–æ–Ω—É—Å–∞");
      }
    }

    async function buyUpgrade(key) {
      const res = await fetch(`${BACKEND}/api/upgrade`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${serverToken}` },
        body: JSON.stringify({ key })
      });
      if (res.ok) {
        const data = await res.json();
        setState(data.state);
        log(`–ö—É–ø–ª–µ–Ω–æ: ${data.upgrade.key} —É—Ä.${data.upgrade.level}`);
      } else {
        log("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º—É—Ä—á–∏–∫–æ–≤ –∏–ª–∏ MAX");
      }
    }

    $("stroke").addEventListener("click", () => {
      strokeQueue++;
      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—á–∫–∞–º–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
      if (strokeQueue >= 3) {
        sendStrokes(strokeQueue);
        strokeQueue = 0;
      } else {
        // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –±—É—Ñ–µ—Ä–∞
        clearTimeout(window._qTimer);
        window._qTimer = setTimeout(() => {
          sendStrokes(strokeQueue);
          strokeQueue = 0;
        }, 120);
      }
      // –º–∞–ª–µ–Ω—å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
      $("cat").classList.add("pulse");
      setTimeout(() => $("cat").classList.remove("pulse"), 120);
    });

    $("daily").addEventListener("click", claimDaily);
    $("shop").addEventListener("click", () => $("shop-panel").classList.remove("hidden"));
    $("close-shop").addEventListener("click", () => $("shop-panel").classList.add("hidden"));
    document.querySelectorAll("#shop-panel .item").forEach(el => {
      el.addEventListener("click", () => buyUpgrade(el.dataset.key));
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
      // –í—Å—Ç–∞–≤—å —Å–≤–æ–π URL backend –≤ —Å–±–æ—Ä–∫–µ (–∑–∞–º–µ–Ω–∏ %BACKEND_PLACEHOLDER%)
      await auth();
      await fetchState();
      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–∞—Å—Å–∏–≤ –∏ —Ä–µ–≥–µ–Ω)
      setInterval(fetchState, 4000);
    })();
  </script>
</body>
</html>
